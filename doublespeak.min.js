/*!
 * Doublespeak JavaScript Library
 *
 * Copyright (c) 2017 Joshua Fan <joshuaptfan@gmail.com>
 * MIT License
 *
 * https://github.com/dblspk/lib
 */
function Doublespeak(a=!1){this.encVals=Object.freeze({'\u200C':0,'\u200D':1,'\u2060':2,'\u2061':3,'\u2062':4,'\u2063':5,'\u2064':6,'\u206A':7,'\u206B':8,'\u206C':9,'\u206D':10,'\u206E':11,'\u206F':12,'\uFE00':13,'\uFE01':14,'\uFEFF':15}),this.encChars=Object.freeze(Object.keys(this.encVals)),this.encodeLength=function(b){let d=[127&b];for(;127<b;)b>>=7,d.unshift(128|127&b);return Uint8Array.from(d)},this.decodeLength=function(b){let d=0;for(var e=0;e<b.length;e++)d=d<<7|127&b[e];return d},this.encodeBytes=function(...b){const d=this.encChars;let e='';for(var f of b){f instanceof Uint8Array||(f=Uint8Array.from(f));for(var g=0,h=f.length;g<h;g++)e+=d[f[g]>>4]+d[15&f[g]]}return e},this.decodeBytes=function(b){const d=this.encVals;let e='',f=[],g=[];for(var k,h=0,j=b.length;h<j;)if(k=d[b[h]],void 0===k)e+=b[h++];else{let o=[];do o.push(k),k=d[b[++h]];while(void 0!=k);16>o.length?e+=o:(1&o.length&&o.pop(),f=f.concat(o),g.push(o.length>>1))}let l=[];for(var h=0,m=f.length;h<m;h+=2)l.push(f[h]<<4|f[h+1]);return{cover:e,bytes:Uint8Array.from(l),seqLens:g}},this.filterStr=function(b){const d=this.encVals;let e='';for(var f=0,g=b.length;f<g;)if(d[b[f]]===void 0)e+=b[f++];else{let h=b[f];for(;d[b[++f]]!==void 0;)h+=b[f];16>h.length&&(e+=h)}return e},this.encodeText=function(b){const d=new TextEncoder().encode(this.filterStr(b)),e=d.length?this.encodeBytes([68,0],this.crc32(d),[1],this.encodeLength(d.length),d):'';return a&&console.info('Original size:',d.length,'bytes,',b.length,'characters','\nEncoded size:',3*e.length,'bytes,',e.length,'characters'),e},this.encodeFile=function(b,d,e){const f=new TextEncoder().encode(b+'\0'+d+'\0');let g=new Uint8Array(f.length+e.length);g.set(f),g.set(e,f.length);const h=this.encodeBytes([68,0],this.crc32(g),[2],this.encodeLength(g.length),g);return a&&console.info('File:',d+',',b||'unknown','\nOriginal size:',e.length,'bytes','\nEncoded size:',3*h.length,'bytes,',h.length,' characters'),h},this.extractText=function(b){return new TextDecoder().decode(b)},this.extractFile=function(b){let d=[];for(var e=0,f=b.length;e<f&&!(!b[e]&&(d.push(e),1<d.length));e++);const g=new TextDecoder().decode(b.subarray(0,d[0])),h=new TextDecoder().decode(b.subarray(d[0]+1,d[1])),j=new Blob([b.subarray(d[1]+1)],{type:g}),k=URL.createObjectURL(j),l=j.size;return{type:g,name:h,url:k,size:l}},this.decodeData=function(b){let{cover:d,bytes:e,seqLens:f}=this.decodeBytes(b),g=[];do{if(!e.length||68!=e[0]||0!=e[1]){if(!e.length)g.push({error:'No message detected'});else{g.push({error:'Protocol mismatch',details:'\nData: '+new TextDecoder().decode(e.subarray(f[0]))}),e=e.subarray(f.shift());continue}break}let h=0;for(;128&e[6+ ++h];);const j=7+h,k=e.subarray(2,j),l=k[4],m=j+this.decodeLength(k.subarray(5)),o=e.subarray(j,m);a&&console.info('Original size:',o.length,'bytes','\nEncoded size:',6*m,'bytes,',2*m,'characters');const p=this.crc32(o).every((q,r)=>q===k[r]);g.push({crcMatch:p,dataType:l,data:o}),p&&(m<f[0]?f[0]-=m:f.shift()),e=e.subarray(p?m:f.shift())}while(e.length);return{cover:d,dataObjs:g}},this.crcTable=Object.freeze((()=>{let b=[],d;for(var e=0;256>e;e++){d=e;for(var f=0;8>f;f++)d=1&d?3988292384^d>>>1:d>>>1;b[e]=d}return b})()),this.crc32=function(b){const d=this.crcTable;let e=-1;for(var f=0,g=b.length;f<g;f++)e=e>>>8^d[255&(e^b[f])];for(e=(-1^e)>>>0,a&&console.info('CRC-32: 0x'+('0000000'+e.toString(16)).slice(-8)),b=[],f=24;0<=f;f-=8)b.push(255&e>>f);return Uint8Array.from(b)}}